<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NUMENE // N.E.T.E.R OS</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NUMENE">

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#05060a;
      --panel:#0b0f18;
      --grid:rgba(0,255,170,.08);
      --neon:#00ffb2;
      --red:#ff2d55;
      --text:#e8f7ff;
      --muted:rgba(232,247,255,.7);
      --shadow: 0 0 14px rgba(0,255,178,.25), 0 0 40px rgba(0,255,178,.12);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    a{color:inherit}
    button{font:inherit}
    ::selection{ background: rgba(0,255,178,.22); }

    /* Background grid + noise */
    .bg{
      position:fixed; inset:0; overflow:hidden; z-index:-2;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(0,255,178,.18), transparent 60%),
        radial-gradient(900px 500px at 80% 30%, rgba(255,45,85,.12), transparent 60%),
        linear-gradient(180deg, #02030a 0%, #05060a 60%, #02030a 100%);
    }
    .grid{
      position:absolute; inset:-20%;
      background-image:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 44px 44px;
      transform: perspective(800px) rotateX(64deg) translateY(-10%);
      filter: blur(.2px);
      opacity:.7;
      animation: drift 9s linear infinite;
    }
    @keyframes drift{
      0%{ transform: perspective(800px) rotateX(64deg) translateY(-10%) translateX(0) }
      100%{ transform: perspective(800px) rotateX(64deg) translateY(-10%) translateX(-44px) }
    }
    .noise{
      position:absolute; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.10;
      animation: noise 1.4s steps(2) infinite;
    }
    @keyframes noise { 0%{transform:translate(0,0)} 100%{transform:translate(-12px, 10px)} }

    /* Layout */
    .wrap{
      min-height:100%;
      padding: 18px 16px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card{
      width:min(520px, 100%);
      background: linear-gradient(180deg, rgba(11,15,24,.92), rgba(6,8,14,.86));
      border: 1px solid rgba(0,255,178,.18);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(600px 280px at 30% 0%, rgba(0,255,178,.16), transparent 60%);
      pointer-events:none;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(0,255,178,.12);
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      letter-spacing:.12em;
      font-weight:700;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--neon);
      box-shadow: 0 0 14px rgba(0,255,178,.9);
      animation: blink 1.1s infinite;
    }
    @keyframes blink{ 0%,60%{opacity:1} 61%,100%{opacity:.25} }

    .body{
      padding: 18px 16px 16px;
    }
    .title{
      font-size: 20px;
      line-height: 1.2;
      margin: 0 0 8px;
    }
    .muted{
      margin:0 0 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    /* Buttons */
    .btn{
      width:100%;
      border: 1px solid rgba(0,255,178,.25);
      background: rgba(0,255,178,.10);
      color: var(--text);
      padding: 14px 14px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: 0 0 0 rgba(0,0,0,0);
      transform: translateZ(0);
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
      position:relative;
      overflow:hidden;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 0 24px rgba(0,255,178,.20); background: rgba(0,255,178,.14); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn .hint{ font-size:12px; opacity:.75; margin-top:6px; }

    /* Glitch text */
    .glitch{
      position:relative;
      display:inline-block;
      text-transform: uppercase;
      letter-spacing:.18em;
    }
    .glitch::before, .glitch::after{
      content: attr(data-text);
      position:absolute; inset:0;
      opacity:.55;
      pointer-events:none;
    }
    .glitch::before{ transform: translate(1px, 0); color: var(--neon); }
    .glitch::after{ transform: translate(-1px, 0); color: var(--red); }
    .glitchPulse{ animation: g 2.4s infinite; }
    @keyframes g{
      0%, 92%, 100% { filter:none; }
      93% { filter: contrast(140%) saturate(130%); transform: skewX(-3deg); }
      94% { filter: contrast(190%) saturate(160%); transform: skewX(3deg); }
      95% { filter:none; transform:none; }
    }

    /* Screens (animated) */
    .screen{
      display:block;
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      height:0;
      overflow:hidden;
      transition: opacity .28s ease, transform .28s ease;
    }
    .screen.active{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
      height:auto;
      overflow:visible;
    }

    /* Boot / log */
    .bootline{
      font-size: 12px;
      color: rgba(232,247,255,.82);
      margin: 0;
      padding: 0;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .scan{
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(0,255,178,.8), transparent);
      box-shadow: 0 0 18px rgba(0,255,178,.25);
      margin: 14px 0 12px;
      animation: scan 1.2s linear infinite;
    }
    @keyframes scan{
      0%{ transform: translateX(-60%); opacity:.2 }
      50%{ opacity:1 }
      100%{ transform: translateX(60%); opacity:.2 }
    }

    /* Progress bar (cinematic boot) */
    .progressWrap{
      margin-top: 10px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(0,255,178,.14);
      border-radius: 999px;
      overflow:hidden;
      height: 10px;
      position:relative;
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(0,255,178,.25), rgba(0,255,178,.92), rgba(255,45,85,.45));
      box-shadow: 0 0 18px rgba(0,255,178,.20);
      transition: width .12s ease;
    }
    .progressText{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(232,247,255,.72);
      letter-spacing: .08em;
      display:flex;
      justify-content:space-between;
    }

    /* Terminal */
    .terminal{
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(0,255,178,.18);
      border-radius: 14px;
      padding: 12px;
      min-height: 260px;
      box-shadow: inset 0 0 30px rgba(0,255,178,.06);
      position:relative;
    }
    .prompt{ color: rgba(0,255,178,.95); }
    .caret{
      display:inline-block; width:10px; height:16px; background: rgba(0,255,178,.85);
      margin-left:6px; vertical-align:middle;
      animation: caret 1s steps(2) infinite;
    }
    @keyframes caret{ 50%{opacity:0} }

    .row{ display:flex; gap:10px; margin-top: 12px; }
    .input{
      flex:1;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(0,255,178,.18);
      border-radius: 12px;
      padding: 12px 12px;
      color: var(--text);
      outline:none;
    }
    .small{
      padding: 12px;
      width:auto;
      background: rgba(255,45,85,.10);
      border-color: rgba(255,45,85,.25);
    }

    /* Cinematic overlays */
    .overlay{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity .12s ease;
      z-index: 50;
    }
    .overlay.on{ opacity:1; }
    .glitchFlash{
      background:
        linear-gradient(0deg, rgba(0,0,0,.92), rgba(0,0,0,.92)),
        repeating-linear-gradient(
          180deg,
          rgba(0,255,178,.0) 0px,
          rgba(0,255,178,.06) 2px,
          rgba(255,45,85,.04) 3px,
          rgba(0,0,0,0) 6px
        );
      mix-blend-mode: screen;
      filter: contrast(140%) saturate(135%);
    }
    .redBlink{
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.88);
    }
    .eye{
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--red);
      box-shadow:
        0 0 12px rgba(255,45,85,.6),
        0 0 36px rgba(255,45,85,.35);
      animation: eye 120ms ease-in-out infinite alternate;
    }
    @keyframes eye{
      from{ transform: scale(.9); opacity:.85 }
      to{ transform: scale(1.1); opacity:1 }
    }
  </style>
</head>

<body>
  <div class="bg">
    <div class="grid"></div>
    <div class="noise"></div>
  </div>

  <!-- overlays -->
  <div id="glitchOverlay" class="overlay glitchFlash"></div>
  <div id="redOverlay" class="overlay redBlink"><div class="eye"></div></div>

  <div class="wrap">
    <div class="card" role="application" aria-label="NUMENE Mini App">
      <div class="topbar">
        <div class="brand">
          <span class="dot"></span>
          <span class="glitch glitchPulse" data-text="NUMENE">NUMENE</span>
        </div>
        <div style="font-size:12px; color:rgba(232,247,255,.65); letter-spacing:.14em;">
          N.E.T.E.R OS
        </div>
      </div>

      <div class="body">

        <!-- SCREEN: BOOT -->
        <section id="boot" class="screen active">
          <h1 class="title"><span class="glitch" data-text="PROTOCOL [DUAT]">PROTOCOL [DUAT]</span></h1>
          <p class="muted">System boot. Connecting to DUAT…</p>

          <div class="terminal" aria-label="Boot log">
            <p id="bootlog" class="bootline"></p>

            <div class="progressWrap" aria-label="Boot progress">
              <div id="progressBar" class="progressBar"></div>
            </div>
            <div class="progressText">
              <span id="progressLabel">CONNECTING…</span>
              <span id="progressPct">0%</span>
            </div>

            <div class="scan"></div>

            <!-- You can still tap it (but auto-enter will happen in 0.9s) -->
            <button id="terminalBtn" class="btn" type="button">
              <div class="glitch" data-text="TERMINAL">TERMINAL</div>
              <div class="hint">Manual enter (optional)</div>
            </button>
          </div>
        </section>

        <!-- SCREEN: TERMINAL -->
        <section id="term" class="screen">
          <h2 class="title"><span class="glitch" data-text="TERMINAL ACCESS">TERMINAL ACCESS</span></h2>
          <p class="muted">Operator session started. Paste the code when you decrypt it.</p>

          <div class="terminal" aria-label="Terminal">
            <div class="bootline">
              <span class="prompt">neter@duat</span>:<span style="color:rgba(232,247,255,.75)">~</span>$ init_session
            </div>
            <div class="bootline" style="margin-top:6px;">
              Auth: <span style="color:rgba(0,255,178,.95)">PENDING</span> — scan sleeve later (next step).
            </div>
            <div class="bootline" style="margin-top:6px;">
              Quest: <span style="color:rgba(255,45,85,.95)">DECRYPT</span> — glow patch + PCB stencil.
            </div>

            <div class="row">
              <input id="code" class="input" placeholder="Enter code (e.g. 4-2-4)" inputmode="numeric" />
              <button id="submit" class="btn small" type="button">VERIFY</button>
            </div>

            <div id="result" class="bootline" style="margin-top:10px; color:rgba(232,247,255,.85)"></div>
            <div class="bootline" style="margin-top:10px;">
              <span class="prompt">neter@duat</span>$ <span class="caret"></span>
            </div>
          </div>

          <div style="margin-top:12px;">
            <button id="back" class="btn" type="button" style="background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.10)">
              ← Back to Boot
            </button>
          </div>
        </section>

      </div>
    </div>
  </div>

<script>
  /**
   * NUMENE Mini App (single-file)
   * - Cinematic boot (0.9s)
   * - Telegram MainButton (TERMINAL / VERIFY)
   * - Haptics + synthesized beep (WebAudio) with autoplay-safe fallback
   */

  // --- Elements ---
  const boot = document.getElementById('boot');
  const term = document.getElementById('term');
  const terminalBtn = document.getElementById('terminalBtn');
  const backBtn = document.getElementById('back');

  const bootlog = document.getElementById('bootlog');
  const progressBar = document.getElementById('progressBar');
  const progressPct = document.getElementById('progressPct');
  const progressLabel = document.getElementById('progressLabel');

  const submit = document.getElementById('submit');
  const codeInput = document.getElementById('code');
  const result = document.getElementById('result');

  const glitchOverlay = document.getElementById('glitchOverlay');
  const redOverlay = document.getElementById('redOverlay');

  // --- Telegram WebApp init ---
  const tg = window.Telegram?.WebApp;

  // --- Audio (beep) ---
  // Important: mobile browsers often block sound until user interacts.
  // We try to play; if blocked, we arm it to play on first tap/keypress.
  let audioCtx = null;
  function ensureAudio(){
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return null;
      audioCtx = new AC();
    }
    return audioCtx;
  }

  function beep({freq=880, duration=0.06, type='sine', gain=0.06} = {}){
    const ctx = ensureAudio();
    if (!ctx) return;

    // If suspended, resume may require user gesture.
    const doPlay = () => {
      try{
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = gain;
        o.connect(g);
        g.connect(ctx.destination);

        const t = ctx.currentTime;
        // tiny fade-in/out to avoid clicks
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(gain, t + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t + duration);

        o.start(t);
        o.stop(t + duration + 0.01);
      } catch(e){}
    };

    if (ctx.state === 'suspended') {
      ctx.resume().then(doPlay).catch(() => armAudioOnce());
    } else {
      doPlay();
    }
  }

  function armAudioOnce(){
    const handler = () => {
      document.removeEventListener('pointerdown', handler);
      document.removeEventListener('keydown', handler);
      try { audioCtx?.resume?.(); } catch(e){}
      // a short confirmation beep on first gesture
      beep({freq: 740, duration: 0.05, type:'square', gain:0.045});
    };
    document.addEventListener('pointerdown', handler, {once:true});
    document.addEventListener('keydown', handler, {once:true});
  }

  // --- Boot typing effect ---
  const lines = [
    "NUMENE // N.E.T.E.R OS",
    "loading: protocol [DUAT] ...",
    "decryptor: online",
    "integrity: OK",
    "gate: awaiting operator input"
  ];

  function typeLines(el, arr){
    let i=0, j=0;
    function step(){
      if(i >= arr.length) return;
      const line = arr[i];
      el.textContent += line[j] ?? "";
      j++;
      if(j > line.length){
        el.textContent += "\n";
        i++; j=0;
      }
      setTimeout(step, j===0 ? 110 : 14);
    }
    step();
  }

  // --- Cinematic overlays ---
  function flashGlitch(ms=90){
    glitchOverlay.classList.add('on');
    setTimeout(() => glitchOverlay.classList.remove('on'), ms);
  }
  function flashRed(ms=90){
    redOverlay.classList.add('on');
    setTimeout(() => redOverlay.classList.remove('on'), ms);
  }

  // --- Screen navigation ---
  let autoTimer = null;

  function setMainButtonFor(screen){
    if(!tg?.MainButton) return;
    if (screen === term) tg.MainButton.setText("VERIFY");
    else tg.MainButton.setText("TERMINAL");
    tg.MainButton.show();
  }

  function show(screen){
    boot.classList.remove('active');
    term.classList.remove('active');
    screen.classList.add('active');

    setMainButtonFor(screen);

    tg?.HapticFeedback?.impactOccurred?.('light');
  }

  // --- Telegram UI init ---
  function initTelegramUI(){
    if(!tg) return;
    try{
      tg.ready();
      tg.expand();
      tg.setHeaderColor?.('#000000');
      tg.setBackgroundColor?.('#000000');
      tg.disableVerticalSwipes?.();

      setMainButtonFor(boot);

      // ONE universal handler:
      tg.MainButton.onClick(() => {
        if (term.classList.contains("active")) submit.click();
        else manualEnterTerminal();
      });

    } catch(e) {}
  }

  // --- Manual enter (button tap) ---
  function manualEnterTerminal(){
    if (autoTimer) clearTimeout(autoTimer);
    // micro cinematic: glitch + beep + red blink then enter
    flashGlitch(80);
    beep({freq: 1040, duration: 0.05, type:'square', gain:0.045});
    setTimeout(() => flashRed(70), 90);
    setTimeout(() => show(term), 160);
  }

  terminalBtn.addEventListener('click', manualEnterTerminal);
  backBtn.addEventListener('click', () => {
    if (autoTimer) clearTimeout(autoTimer);
    show(boot);
  });

  // --- Verify demo (заменишь потом на реальную проверку/сервер) ---
  submit.addEventListener('click', () => {
    const v = (codeInput.value || "").trim();
    if(!v){
      result.textContent = "ERR: empty code. Try again.";
      tg?.HapticFeedback?.notificationOccurred?.('error');
      beep({freq: 220, duration: 0.08, type:'sine', gain:0.06});
      return;
    }
    if(v.replace(/\s/g,'') === "4-2-4"){
      result.textContent = "OK: Verified Operator ✅ — (next: unlock chat / tokens)";
      tg?.HapticFeedback?.notificationOccurred?.('success');
      // success arpeggio
      beep({freq: 660, duration: 0.05, type:'sine', gain:0.05});
      setTimeout(() => beep({freq: 990, duration: 0.06, type:'sine', gain:0.05}), 70);
    } else {
      result.textContent = "DENIED: wrong code ❌";
      tg?.HapticFeedback?.notificationOccurred?.('error');
      beep({freq: 180, duration: 0.10, type:'square', gain:0.05});
    }
  });

  // --- Boot timeline (0.9s) ---
  function setProgress(p, label){
    const clamped = Math.max(0, Math.min(100, p));
    progressBar.style.width = clamped + "%";
    progressPct.textContent = Math.round(clamped) + "%";
    if (label) progressLabel.textContent = label;
  }

  function bootCinematic900ms(){
    // If audio is blocked, arm it to play on first tap
    armAudioOnce();

    // start typing log
    typeLines(bootlog, lines);

    // progress stages inside 900ms
    const t0 = performance.now();

    // subtle boot beeps (may be blocked until user interaction)
    setTimeout(() => beep({freq: 520, duration: 0.03, type:'sine', gain:0.04}), 80);
    setTimeout(() => beep({freq: 740, duration: 0.03, type:'sine', gain:0.04}), 160);
    setTimeout(() => beep({freq: 880, duration: 0.03, type:'sine', gain:0.04}), 240);

    setProgress(8,  "HANDSHAKE…");
    setTimeout(() => setProgress(22, "PING DUAT…"), 120);
    setTimeout(() => setProgress(41, "SYNC TIME…"), 240);
    setTimeout(() => setProgress(63, "VERIFY CHANNEL…"), 420);

    // glitch moment around 0.78s
    setTimeout(() => {
      setProgress(82, "BYPASS NOISE…");
      flashGlitch(95);
      beep({freq: 1200, duration: 0.04, type:'square', gain:0.04});
      tg?.HapticFeedback?.impactOccurred?.('medium');
    }, 780);

    // red blink right before enter
    setTimeout(() => {
      setProgress(96, "LOCK ACQUIRED");
      flashRed(85);
      beep({freq: 980, duration: 0.03, type:'sine', gain:0.05});
    }, 860);

    // enter at 0.9s
    autoTimer = setTimeout(() => {
      setProgress(100, "ENTERING TERMINAL");
      show(term);
      // tiny confirmation beep (may still be blocked)
      beep({freq: 660, duration: 0.04, type:'sine', gain:0.05});
    }, 900);
  }

  // --- PWA service worker ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  // Start
  initTelegramUI();
  bootCinematic900ms();
</script>
</body>
</html>
